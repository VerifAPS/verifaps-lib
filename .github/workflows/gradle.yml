name: Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - run: ./gradlew assemble :exec:assembleDist

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: "**/build/**"


  test:
    runs-on: ubuntu-latest
    needs: [ "build" ]
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4

      - name: Setup nuXmv
        uses: verifaps/setup-nuxmv@v0.1.2

      - name: Test nuXmv
        run: echo "quit" | nuXmv -int | head -n 1

      - name: setup-smt
        uses: keyproject/setup-smt@v0.1.3

      - name: Test z3
        run: z3 -version            

      - run: ./gradlew test

  integration-tests:
    needs: [ "build" ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4

      - name: Setup nuXmv
        uses: verifaps/setup-nuxmv@v0.1.2

      - name: Test nuXmv
        run: echo "quit" | nuXmv -int | head -n 1

      - name: setup-smt
        uses: keyproject/setup-smt@v0.1.3

      - name: Test z3
        run: z3 -version            

      - name: Run integration tests
        run: share/integration-tests.sh

  ttsynth-test:
    runs-on: ubuntu-latest
    needs: [ "build" ]
    steps:

      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4

      - name: Setup nuXmv
        uses: verifaps/setup-nuxmv@v0.1.2

      - name: Test nuXmv
        run: echo "quit" | nuXmv -int | head -n 1

      - name: setup-smt
        uses: keyproject/setup-smt@v0.1.3

      - name: Test z3
        run: z3 -version

      - run: python --version
      - run: g++ --version
      - run: javac -version
      - run: z3 -version

      - name: Synthesis Tests
        run: |
          cd geteta/examples/synthesis_test_cases
          ../../../exec/build/install/exec/bin/ttsynth --python=/usr/bin/python3 files/* -o generated/
          ./gradlew test --info
          